<?php
// ===========================================
// 投稿一覧表示（index.php）
// ===========================================
// ログイン済みユーザーのみアクセス可能
// 全ての投稿を新しい順に表示
// 自分の投稿のみ編集・削除が可能
// ===========================================


// -----------------------------------------
// 1. セッション開始（最初に記述必須！）
// -----------------------------------------
session_start();


// -----------------------------------------
// 2. 共通関数ファイルを読み込み
// -----------------------------------------
include("funcs.php");


// -----------------------------------------
// 3. ログイン状態をチェック
// -----------------------------------------
// ★ヒント: もしこの処理がなかったらどうなる？
// 未ログインでもこのページにアクセスできてしまいます。
// なぜこの1行が必要なのか、説明できるようになろう！
// セッションIDという仮の番号札を入口で配らないと、http://localhost/php_kadai/ にログインすると全員入れてしまう。
// -----------------------------------------
sschk();


// ===========================================
// ★★★ 疎通確認用（Step 1, 2 の確認が終わったら削除！）★★★
// ===========================================
// ここまで来れたらログイン成功！
// Step 3 に進む前にこの行を削除してね
// exit('ログイン成功！index.php まで到達しました。Step1, 2 が完了したらこの行を削除して Step 3 に進もう！');
// ===========================================


// -----------------------------------------
// 4. DB接続
// -----------------------------------------
$pdo = db_conn();


// -----------------------------------------
// TODO: 5. SELECT文を作成・実行
// -----------------------------------------
// posts テーブルと users テーブルを JOIN して、
// 投稿データと一緒に投稿者名も取得しよう
// 
// 【JOINの書き方例 1行で書きましょう】
// SELECT posts.*, users.name as user_name 
// FROM posts 
// JOIN users ON posts.user_id = users.id 
// ORDER BY posts.created_at DESC
// -----------------------------------------
/* ↓↓↓ ここにコードを追加 ↓↓↓ */
$sql = "SELECT posts.*, users.name as user_name FROM posts JOIN users ON posts.user_id = users.id ORDER BY posts.created_at DESC";
/* ↑↑↑ ここまで ↑↑↑ */
$stmt = $pdo->prepare($sql);
$status = $stmt->execute();

// SELECT posts.*, users.name as user_name
// 「取得するデータは、postsテーブルの全データ（*）と、usersテーブルのname（名前）です」と指定しています。
// as user_name は、取得した名前のデータに user_name という「あだ名（エイリアス）」をつけています。
// 複数のテーブルを使うとカラム名（項目名）が被ることがあるため、区別しやすくするために念のためつける。
// というか今回の場合は被るので、必ずusersテーブル側はダミーの名前がいる。
// なぜならログイン情報の項目とusersテーブルの項目は一致しているはずだから。
// FROM posts
// 「ベースとなるテーブルは posts（投稿データ）です」という指定です。
// JOIN users ON posts.user_id = users.id
// ここが最大のポイントです。「postsテーブルに、users（ユーザー情報）テーブルを**くっつけて（JOIN）**ね」と指示しています。
// そして ON の後ろで、**「くっつける時の条件（鍵）は、postsの『user_id』と、usersの『id』が同じもの同士だよ」**と指定しています。これで、「誰が書いた投稿なのか」が紐づきます。
// ORDER BY posts.created_at DESC
// 「最後に、投稿された日時（created_at）の降順（DESC＝新しい順）に並べ替えてね」という指示です

// -----------------------------------------
// 6. データ表示用のHTML文字列を生成
// -----------------------------------------
$view = "";

if ($status == false) {
    sql_error($stmt);
} else {
    while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
        $view .= '<div class="post-card">';
        $view .= '  <div class="post-header">';
        $view .= '    <span class="post-author">' . h($row["user_name"]) . '</span>';
        $view .= '    <span class="post-date">' . h($row["created_at"]) . '</span>';
        $view .= '  </div>';
        $view .= '  <div class="post-content">' . h($row["content"]) . '</div>';

// **「①取り出すルール」「②1件取り出す」「③なくなるまで繰り返す」**の3つのステップに分解して解説します。
// ① PDO::FETCH_ASSOC（取り出す時の便利なルール）
// データベースからデータを取り出すとき、コンピュータに対して「どういう形でデータを受け取りたいか」を指定します。
// FETCH_ASSOC（フェッチ・アソック）は、**「データベースの表の見出し（カラム名）を、そのまま箱のラベル（キー）にして持ってきてね」**という指示です。
// これを指定することで、持ってきたデータをPHP側で使うときに：
// ❌ $row や $row（「1番目のデータ」と言われても何が入っているか分からない）
// ⭕️ $row["name"] や $row["email"]（見出しの名前で取り出せるから一目で分かる！） というように、直感的にデータを扱える「連想配列（名前つきの箱）」として受け取ることができるようになります。
// ② $stmt->fetch(...)（1行だけ持ってくる）
// fetch()（フェッチ）は、英語で「取ってくる」という意味です。 データベースの中には、何十件、何百件というデータが入っているかもしれません。しかし、この fetch() を1回発動すると、一気に全部持ってくるのではなく**「上から順番に、1行分（1件分）だけ」**データを取ってきます。
// そして、取ってきた1件分のデータを、左側に書かれている $row という変数（箱）に入れています（代入）。
// ③ while (...)（なくなるまで繰り返す）
// while は「カッコの中の条件が成立している間は、ずっと同じ処理を繰り返す」という機能です。
// $stmt->fetch() は**「データがあるうちはデータを取ってくるけれど、もう底を突いてデータがなくなったら false（もう無いよ！という合図）を出す」**という特別な仕組みを持っています。
// そのため、この1行のコードは以下のような動きを全自動で行ってくれます。
// 1周目：1件目のデータを取ってきて $row に入れる。データがあったのでループの中身（HTMLを作る処理）を実行！
// 2周目：2件目のデータを取ってきて $row の中身を上書きする。データがあったので実行！
// （中略）
// 最後：もうデータがない！ fetch() が **false（もう無いよ）**を返す。
// 終了：while が「あ、false が出たからここで繰り返しは終わりだね」と判断してループを抜ける。

        // -----------------------------------------
        // TODO: 7. 自分の投稿のみ編集・削除ボタンを表示
        // -----------------------------------------
        // 投稿の user_id と、ログイン中のユーザーIDを比較しよう
        // ヒント: ログイン時に $_SESSION["user_id"] にログイン中のユーザーIDを保存しましたね？
        // （login_act.php の手順7を見てみよう）
        // -----------------------------------------
        /* ↓↓↓ ここにコードを追加（if文の条件を書く）↓↓↓ */
        if ($_SESSION["user_id"]  == $row["user_id"]) {
            /* ↑↑↑ ここまで ↑↑↑ */
            // $row["user_id"] user_idのrowデータ（行のデータなので生データのこと）
            // $_SESSION["user_id"]（ログインしている自分のID）と $row["user_id"]（今表示しようとしている投稿の作者ID）を == で正しく比較できています。
            $view .= '  <div class="post-actions">';
            $view .= '    <a href="edit.php?id=' . h($row["id"]) . '" class="btn btn-secondary btn-sm">編集</a>';
            $view .= '    <a href="delete.php?id=' . h($row["id"]) . '" class="btn btn-danger btn-sm" onclick="return confirm(\'本当に削除しますか？\')">削除</a>';
            $view .= '  </div>';
        }

        $view .= '</div>';
    }
}
?>
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投稿一覧 | 掲示板アプリ</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- ===========================================
     ナビゲーション
     =========================================== -->
    <nav class="navbar">
        <a class="navbar-brand" href="index.php">掲示板アプリ</a>
        <div class="navbar-links">
            <a href="index.php">投稿一覧</a>
            <a href="create.php">新規投稿</a>
        </div>
        <div class="navbar-user">
            <span class="navbar-user-info">
                <span class="navbar-user-name"><?= h($_SESSION["user_name"]) ?></span>
            </span>
            <a href="logout.php" class="logout-link">ログアウト</a>
        </div>
    </nav>

    <!-- ===========================================
     メインコンテンツ
     =========================================== -->
    <div class="container">
        <h1 class="page-title">投稿一覧</h1>

        <!-- -----------------------------------------
         投稿一覧表示エリア
         ----------------------------------------- -->
        <?php if ($view): ?>
            <?= $view ?>
        <?php else: ?>
            <div class="empty-state">
                <div class="empty-state-icon">📝</div>
                <div class="empty-state-text">まだ投稿がありません</div>
                <a href="create.php" class="btn btn-primary">最初の投稿をする</a>
            </div>
        <?php endif; ?>

        <!-- -----------------------------------------
         新規投稿へのリンク
         ----------------------------------------- -->
        <?php if ($view): ?>
            <div class="text-center mt-4">
                <a href="create.php" class="btn btn-primary">新規投稿する</a>
            </div>
        <?php endif; ?>
    </div>

    <!-- ===========================================
     フッター
     =========================================== -->
    <footer class="footer">
        <p>PHP課題 掲示板アプリ - CRUD + ログイン機能の学習用</p>
    </footer>

</body>

</html>