<?php
// ===========================================
// 投稿更新処理（update_act.php）
// ===========================================
// ログイン済みユーザーのみ実行可能
// 自分の投稿のみ更新可能
// ===========================================


// -----------------------------------------
// 1. セッション開始
// -----------------------------------------
session_start();


// -----------------------------------------
// 2. 共通関数ファイルを読み込み
// -----------------------------------------
include("funcs.php");


// -----------------------------------------
// 3. ログイン状態をチェック
// -----------------------------------------
sschk();


// -----------------------------------------
// 4. POSTデータとセッションからデータを取得
// -----------------------------------------
$id      = $_POST["id"];
$content = $_POST["content"];
$user_id = $_SESSION["user_id"];


// -----------------------------------------
// 5. DB接続
// -----------------------------------------
$pdo = db_conn();


// -----------------------------------------
// TODO: 6. UPDATE文を作成・実行
// -----------------------------------------
// posts テーブルの投稿を更新しよう
// ★重要: WHERE句で id と user_id を指定して、
// 自分の投稿のみ更新できるようにしよう
// 
// php02 の update.php を参考に！
// -----------------------------------------
/* ↓↓↓ ここにSQLを書く ↓↓↓ */
$sql = "UPDATE posts
        SET content = :content
        -- SETには更新したいものだけ入れる。
        WHERE id = :id AND user_id = :user_id";
        // もしあなたが書いたシステムが WHERE id = :id しか確認していない場合、以下のような事件が起きます。
// Aさんがログインして、自分の投稿（ID: 5）を編集しようとする。URLは edit.php?id=5。
// Aさんはふとイタズラを思いつき、URLの数字を適当に edit.php?id=10 に書き換えてアクセスしてみる。
// 画面にはBさんが書いた投稿（ID: 10）が表示されない仕組みにしていたとしても、Aさんが強制的に更新ボタンを押してデータを送信する。
// データベースは「あ、IDが10番の投稿を更新すればいいんですね！了解です！」と盲目的に指示に従い、Bさんの投稿内容がAさんの文章に上書きされてしまう。
// IDはあくまでセッションIDでログインの順番でしかなく、書き変えは容易。
/* ↑↑↑ ここまで ↑↑↑ */

$stmt = $pdo->prepare($sql);
$stmt->bindValue(':content', $content, PDO::PARAM_STR);
$stmt->bindValue(':id',      $id,      PDO::PARAM_INT);
$stmt->bindValue(':user_id', $user_id, PDO::PARAM_INT);

$status = $stmt->execute();


// -----------------------------------------
// 7. 実行結果の判定とリダイレクト
// -----------------------------------------
if ($status == false) {
    sql_error($stmt);
} else {
    redirect("index.php");
}

