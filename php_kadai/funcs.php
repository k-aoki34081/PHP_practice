<?php
// ===========================================
// 共通関数ファイル（funcs.php）
// ===========================================
// このファイルには、複数のページで使用する
// 共通の関数をまとめています。
// 各ページで include("funcs.php"); として読み込みます。
// ===========================================


// -----------------------------------------
// XSS対策用のエスケープ関数
// -----------------------------------------
// 使用場所: HTMLに値を出力する全ての箇所
// 目的: <script>などの悪意あるコードを無効化
// -----------------------------------------
function h($str)
{
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}


// -----------------------------------------
// データベース接続関数
// -----------------------------------------
// 戻り値: PDOオブジェクト
// 目的: DB接続処理を1箇所にまとめて保守性向上
// -----------------------------------------
function db_conn()
{
    try {
        // -----------------------------------------
        // ローカル環境（XAMPP/MAMP）の設定
        // -----------------------------------------
        $db_name = "board_db";   // データベース名
        $db_id   = "root";       // ユーザー名
        $db_pw   = "";           // パスワード（XAMPPは空、MAMPは"root"）
        $db_host = "localhost";  // ホスト名

        // -----------------------------------------
        // 本番環境の設定（さくらサーバーなど）
        // localhost以外の場合に切り替わる
        // -----------------------------------------
        if ($_SERVER["HTTP_HOST"] != 'localhost') {
            $db_name = "";       // 本番環境のDB名
            $db_id   = "";       // 本番環境のユーザー名
            $db_pw   = "";       // 本番環境のパスワード
            $db_host = "";       // 本番環境のホスト名
        }

        // -----------------------------------------
        // PDOでデータベースに接続 PDOオブジェクト化してデータを引っ張らないと、
        // 入力欄に悪意のあるSQL文が入ると実行してしまう。
        // prepare() や bindValue() は funcs.php の中には書かれていません。
        // なぜなら、これらは私たちが自分で作る関数ではなく、**「PHPという言語に最初から組み込まれている標準機能（PDOの機能）」**だからです。
        // 資料『PHP02 - データベース連携』によると、funcs.php の中に記述してあるのは、私たちが毎回書く手間を省くために自作した以下の4つの「便利ツール」だけです。
        // h() : XSS（クロスサイトスクリプティング）対策用の関数
        // db_conn() : データベースに接続するための関数
        // sql_error() : SQLのエラーを表示する関数
        // redirect() : ページを移動（リダイレクト）する関数
        // では、なぜ prepare() が使えるのか？
        // funcs.php の中にある db_conn() という自作関数のコードを見ると、最後に return new PDO(...) と書かれています。
        // ここでPHP本体に最初から用意されている「PDOクラス（プロが作った巨大な設計図）」を呼び出しています。この new PDO(...) によって作られた鍵（$pdo）の中には、すでにPHP本体側でプログラムされた prepare() などのセキュリティ機能が「全部入り」でパックされています。
        // つまり、**「funcs.php（自作の道具箱）を使って巨大な冷蔵庫の鍵（$pdo）を取り出したら、その鍵には最初から安全装置（prepare や bindValue）が内蔵されていた」**という状態です。
        // 私たちが funcs.php に prepare() の中身をわざわざ書かなくても使えるのは、PHPという言語自体がその機能を最初から持っているからです。
        //// -----------------------------------------
        return new PDO(
            'mysql:dbname=' . $db_name . ';charset=utf8;host=' . $db_host,
            $db_id,
            $db_pw
        );
    } catch (PDOException $e) {
        // 接続エラーの場合はメッセージを表示して終了
        exit('DB Connection Error: ' . $e->getMessage());
    }
}


// -----------------------------------------
// SQLエラー表示関数
// -----------------------------------------
// 引数: $stmt - PDOStatementオブジェクト
// 目的: SQLエラー処理を統一化
// -----------------------------------------
function sql_error($stmt)
{
    $error = $stmt->errorInfo();
    exit("SQL Error: " . $error[2]);
}


// -----------------------------------------
// リダイレクト関数
// -----------------------------------------
// 引数: $file_name - リダイレクト先のファイル名
// 目的: ページ遷移処理を統一化
// -----------------------------------------
function redirect($file_name)
{
    header("Location: " . $file_name);
    exit();
}


// ===========================================
// セッション関連の関数
// ===========================================


// -----------------------------------------
// セッションチェック関数
// -----------------------------------------
// 目的: ログイン状態の確認
// 処理: 
//   1. セッションIDが正しいか確認
//   2. セッション固定攻撃対策としてIDを再生成
//   3. 未ログインの場合はログイン画面にリダイレクト
// -----------------------------------------
function sschk()
{
    // -----------------------------------------
    // TODO: セッションのチェック処理を実装
    // -----------------------------------------
    // php03 の funcs.php にある sschk() を参考に、
    // セッションチェックの処理を書き写してみよう。
    // 
    // ★この関数は何をチェックしている？
    // ★なぜこのチェックが必要？
    // 書き写しながら、ロジックを理解しよう！
    // -----------------------------------------
    /* ↓↓↓ ここにコードを追加 ↓↓↓ */

 // セッションIDが設定されていない、または不一致の場合
    if (!isset($_SESSION["chk_ssid"]) || $_SESSION["chk_ssid"] != session_id()) {
        // ログインエラー画面を表示
        exit('ログインエラーです');
    } else {
        // -----------------------------------------
        // セッション固定攻撃対策
        // -----------------------------------------
        // セッションIDを再生成することで、
        // 攻撃者が事前に用意したセッションIDを無効化
        // -----------------------------------------
        session_regenerate_id(true);
        $_SESSION["chk_ssid"] = session_id();
    }
    /* ↑↑↑ ここまで ↑↑↑ */
}
