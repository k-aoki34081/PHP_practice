<?php
// ===========================================
// 投稿登録処理（create_act.php）
// ===========================================
// ログイン済みユーザーのみ実行可能
// ===========================================


// -----------------------------------------
// 1. セッション開始
// -----------------------------------------
session_start();


// -----------------------------------------
// 2. 共通関数ファイルを読み込み
// -----------------------------------------
include("funcs.php");


// -----------------------------------------
// 3. ログイン状態をチェック
// -----------------------------------------
sschk();


// -----------------------------------------
// 4. POSTデータとセッションからデータを取得
// -----------------------------------------
$content = $_POST["content"];
$user_id = $_SESSION["user_id"];


// -----------------------------------------
// 5. DB接続
// -----------------------------------------
$pdo = db_conn();


// -----------------------------------------
// TODO: 6. INSERT文を作成・実行
// -----------------------------------------
// posts テーブルに新しい投稿を登録しよう
// php02 の insert.php を参考に！
// -----------------------------------------
/* ↓↓↓ ここにSQLを書く ↓↓↓ */
$sql = "INSERT INTO posts (user_id, content, created_at) 
        VALUES (:user_id, :content, sysdate())" ;
/* ↑↑↑ ここまで ↑↑↑ */

$stmt = $pdo->prepare($sql);
$stmt->bindValue(':user_id', $user_id, PDO::PARAM_INT);
$stmt->bindValue(':content', $content, PDO::PARAM_STR);

$status = $stmt->execute();


// -----------------------------------------
// 7. 実行結果の判定とリダイレクト
// -----------------------------------------
if ($status == false) {
    sql_error($stmt);
} else {
    redirect("index.php");
}

