<?php
// ===========================================
// ログイン認証処理（login_act.php）
// ===========================================
// このファイルは login.php のフォームから
// POSTで送信されたデータで認証を行います。
// ===========================================


// -----------------------------------------
// 1. セッション開始（最初に記述必須！）
// -----------------------------------------
session_start();


// -----------------------------------------
// 2. POSTデータを取得
// -----------------------------------------
$email    = $_POST["email"];
$password = $_POST["password"];


// -----------------------------------------
// 3. 共通関数ファイルを読み込み、DB接続 
// phpは、include()という関数で、他のfuncs.php という別のｐｈｐファイルに書かれている関数をinclude()で呼び出せる。
// 「読み込んだ funcs.php の中に定義されている db_conn() という関数（データベース接続処理）を実行し、
// その結果を $pdo という変数に格納してね」という命令
// 接続が成功すると、データベースを操作するための「鍵」や「窓口」のような役割を果たすデータ（PDOオブジェクト）が返ってきます。それを $pdo という名前の変数で受け取っておくことで、
// この後に行うデータの登録（INSERT）や取得（SELECT）といった操作が可能になります
// -----------------------------------------
include("funcs.php");
$pdo = db_conn();


// -----------------------------------------
// TODO: 4. ユーザー検索SQL作成・実行
// -----------------------------------------
// ★注意: php03では「lid」でしたが、
// 今回は「email」カラムで検索します！
// -----------------------------------------
/* ↓↓↓ ここにコードを追加 ↓↓↓ */
// この :（コロン）から始まる言葉（今回の場合は :email）は、**「プレースホルダー」と呼ばれる、データを後からはめ込むための「空欄（目印）」**です
// 「ここは後でメールアドレスのデータを入れるから、とりあえず :email という名前の空欄にしておくね」と、SQL文をテンプレートとして準備します
// そして、bindValue() で後から安全にはめ込む
$stmt = $pdo->prepare("SELECT * FROM users WHERE email = :email");
// bindValue()でプレースホルダーに値をバインド
$stmt->bindValue(':email', $email, PDO::PARAM_STR);
$status = $stmt->execute();
/* ↑↑↑ ここまで ↑↑↑ */


// -----------------------------------------
// 5. SQL実行時にエラーがある場合の処理
// -----------------------------------------
if ($status == false) {
    sql_error($stmt);
}


// -----------------------------------------
// 6. ユーザー情報を取得
// -----------------------------------------
$user = $stmt->fetch();


// -----------------------------------------
// 7. パスワード検証と認証処理
// -----------------------------------------
if ($user && password_verify($password, $user["password"])) {
    // -----------------------------------------
    // ログイン成功時の処理
    // -----------------------------------------
    
    // セッションにユーザー情報を保存
    // PHPの連想配列という一種で、
    // 前の変数宣言などは一切必要なく、[]の中に直接好きな名前（文字列）を書くだけで、その場で新しい箱を作ることができます
    $_SESSION["chk_ssid"]  = session_id();
    $_SESSION["user_id"]   = $user['id'];
    $_SESSION["user_name"] = $user['name'];
    
    // セッション固定攻撃対策
    session_regenerate_id(true);
    $_SESSION["chk_ssid"] = session_id();
    
    // 投稿一覧画面にリダイレクト
    redirect("index.php");
    
} else {
    // -----------------------------------------
    // ログイン失敗時の処理
    // -----------------------------------------
    redirect("login.php");
}

