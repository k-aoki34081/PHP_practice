<?php
// ===========================================
// 投稿削除処理（delete.php）
// ===========================================
// ログイン済みユーザーのみ実行可能
// 自分の投稿のみ削除可能
// ===========================================


// -----------------------------------------
// 1. セッション開始
// -----------------------------------------
session_start();


// -----------------------------------------
// 2. 共通関数ファイルを読み込み
// -----------------------------------------
include("funcs.php");


// -----------------------------------------
// 3. ログイン状態をチェック
// -----------------------------------------
sschk();


// -----------------------------------------
// 4. GETパラメータとセッションからデータを取得
// -----------------------------------------
$id      = $_GET["id"];
$user_id = $_SESSION["user_id"];


// -----------------------------------------
// 5. DB接続
// -----------------------------------------
$pdo = db_conn();


// -----------------------------------------
// TODO: 6. DELETE文を作成・実行
// -----------------------------------------
// posts テーブルから投稿を削除しよう
// ★重要: WHERE句で id と user_id を指定して、
// 自分の投稿のみ削除できるようにしよう
// -----------------------------------------
/* ↓↓↓ ここにSQLを書く ↓↓↓ */
$sql = "DELETE FROM posts WHERE id = :id AND user_id = :user_id";
/* ↑↑↑ ここまで ↑↑↑ */

$stmt = $pdo->prepare($sql);
$stmt->bindValue(':id',      $id,      PDO::PARAM_INT);
$stmt->bindValue(':user_id', $user_id, PDO::PARAM_INT);

$status = $stmt->execute();


// -----------------------------------------
// 7. 実行結果の判定とリダイレクト
// -----------------------------------------
if ($status == false) {
    sql_error($stmt);
} else {
    redirect("index.php");
}

