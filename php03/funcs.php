<?php
// ===========================================
// 共通関数ファイル（funcs.php）
// ===========================================
// このファイルには、複数のページで使用する
// 共通の関数をまとめています。
// 各ページで include("funcs.php"); として読み込みます。
// ===========================================


// -----------------------------------------
// XSS対策用のエスケープ関数
// -----------------------------------------
// 使用場所: HTMLに値を出力する全ての箇所
// 目的: <script>などの悪意あるコードを無効化
// -----------------------------------------
function h($str) {
    return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
}


// -----------------------------------------
// データベース接続関数
// -----------------------------------------
// 戻り値: PDOオブジェクト
// 目的: DB接続処理を1箇所にまとめて保守性向上
// -----------------------------------------
function db_conn() {
    try {
        // -----------------------------------------
        // ローカル環境（XAMPP/MAMP）の設定
        // -----------------------------------------
        $db_name = "gs_db_login";  // データベース名
        $db_id   = "root";       // ユーザー名
        $db_pw   = "";           // パスワード（XAMPPは空、MAMPは"root"）
        $db_host = "localhost";  // ホスト名

        // -----------------------------------------
        // 本番環境の設定（さくらサーバーなど）
        // localhost以外の場合に切り替わる
        // -----------------------------------------
        if ($_SERVER["HTTP_HOST"] != 'localhost') {
            $db_name = "";       // 本番環境のDB名
            $db_id   = "";       // 本番環境のユーザー名
            $db_pw   = "";       // 本番環境のパスワード
            $db_host = "";       // 本番環境のホスト名
        }

        // -----------------------------------------
        // PDOでデータベースに接続
        // -----------------------------------------
        return new PDO(
            'mysql:dbname=' . $db_name . ';charset=utf8;host=' . $db_host,
            $db_id,
            $db_pw
        );

    } catch (PDOException $e) {
        // 接続エラーの場合はメッセージを表示して終了
        exit('DB Connection Error: ' . $e->getMessage());
    }
}


// -----------------------------------------
// SQLエラー表示関数
// -----------------------------------------
// 引数: $stmt - PDOStatementオブジェクト
// 目的: SQLエラー処理を統一化
// -----------------------------------------
function sql_error($stmt) {
    $error = $stmt->errorInfo();
    exit("SQL Error: " . $error[2]);
}


// -----------------------------------------
// リダイレクト関数
// -----------------------------------------
// 引数: $file_name - リダイレクト先のファイル名
// 目的: ページ遷移処理を統一化
// -----------------------------------------
function redirect($file_name) {
    header("Location: " . $file_name);
    exit();
}


// ===========================================
// セッション関連の関数（PHP03で追加）
// ===========================================


// -----------------------------------------
// セッションチェック関数
// -----------------------------------------
// 目的: ログイン状態の確認
// 処理: 
//   1. セッションIDが正しいか確認
//   2. セッション固定攻撃対策としてIDを再生成
//   3. 未ログインの場合はエラー表示
// -----------------------------------------
function sschk() {
    // セッションIDが設定されていない、または不一致の場合
    if (!isset($_SESSION["chk_ssid"]) || $_SESSION["chk_ssid"] != session_id()) {
        // ログインエラー画面を表示
        exit('ログインエラーです');
    } else {
        // -----------------------------------------
        // セッション固定攻撃対策
        // -----------------------------------------
        // セッションIDを再生成することで、
        // 攻撃者が事前に用意したセッションIDを無効化
        // -----------------------------------------
        session_regenerate_id(true);
        $_SESSION["chk_ssid"] = session_id();
    }
}


// -----------------------------------------
// 管理者権限チェック関数
// -----------------------------------------
// 目的: 管理者のみがアクセスできるページの保護
// 戻り値: true（管理者）/ false（一般ユーザー）
// -----------------------------------------
function is_admin() {
    return isset($_SESSION["kanri_flg"]) && $_SESSION["kanri_flg"] == 1;
}


// -----------------------------------------
// 管理者権限必須チェック関数
// -----------------------------------------
// 目的: 管理者以外がアクセスした場合にエラー表示
// -----------------------------------------
function require_admin() {
    if (!is_admin()) {
        exit('
            <!DOCTYPE html>
            <html lang="ja">
            <head>
                <meta charset="UTF-8">
                <title>アクセス権限エラー</title>
                <link rel="stylesheet" href="css/style.css">
            </head>
            <body>
                <div class="container">
                    <div class="card" style="margin-top: 100px;">
                        <h2 class="card-title">アクセス権限エラー</h2>
                        <p>このページへのアクセス権限がありません。</p>
                        <p>管理者のみがアクセスできます。</p>
                        <div class="btn-group">
                            <a href="select.php" class="btn btn-secondary">一覧に戻る</a>
                        </div>
                    </div>
                </div>
            </body>
            </html>
        ');
    }
}

