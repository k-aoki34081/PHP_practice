<?php
// ===========================================
// ログイン認証処理（login_act.php）
// ===========================================
// このファイルは login.php のフォームから
// POSTで送信されたデータで認証を行います。
// ===========================================


// -----------------------------------------
// 1. セッション開始（最初に記述必須！）
// -----------------------------------------
// ★ セッション関連の処理を行う前に必ず呼び出す
// -----------------------------------------
// session_start() を呼び出す


// -----------------------------------------
// ★ 2. POSTデータを取得
// -----------------------------------------
$lid = $_POST["lid"];
$lpw = $_POST["lpw"];


// -----------------------------------------
// 3. 共通関数ファイルを読み込み、DB接続
// -----------------------------------------
include("funcs.php");
$pdo = db_conn();


// -----------------------------------------
// 4. ユーザー検索SQL作成・実行
// -----------------------------------------
// ※パスワードはハッシュ化されているため、
//   ログインIDのみで検索し、後でパスワードを検証
// -----------------------------------------
$stmt = $pdo->prepare("SELECT * FROM gs_user_table WHERE lid = :lid");
$stmt->bindValue(':lid', $lid, PDO::PARAM_STR);
$status = $stmt->execute();


// -----------------------------------------
// 5. SQL実行時にエラーがある場合の処理
// -----------------------------------------
if ($status == false) {
    sql_error($stmt);
}


// -----------------------------------------
// 6. ユーザー情報を取得
// -----------------------------------------
// fetch() で1件のみ取得
// ユーザーが見つからない場合は false が返る
// -----------------------------------------
$val = $stmt->fetch();


// -----------------------------------------
// 7. パスワード検証と認証処理
// -----------------------------------------
// password_verify() でハッシュ化パスワードと比較
// $val && password_verify($lpw, $val["lpw"]) 
//
// ※まだハッシュ化していない場合は以下のコードで平文比較：
// $val && $val["lpw"] == $lpw
// -----------------------------------------
if ("xxxxxxxxxxxxxxxxxxxx") {
    // -----------------------------------------
    // ログイン成功時の処理
    // -----------------------------------------
    
    // セッションにユーザー情報を保存
    $_SESSION["chk_ssid"]  = session_id();      // セッションID（認証用）
    $_SESSION["kanri_flg"] = $val['kanri_flg']; // 管理者フラグ
    $_SESSION["name"]      = $val['name'];      // ユーザー名
    $_SESSION["user_id"]   = $val['id'];        // ユーザーID
    
    // -----------------------------------------
    // セッション固定攻撃対策
    // -----------------------------------------
    // ログイン成功後にセッションIDを再生成することで、
    // 攻撃者が事前に用意したセッションIDを無効化
    // -----------------------------------------
    session_regenerate_id(true);
    $_SESSION["chk_ssid"] = session_id();
    
    // 一覧画面にリダイレクト
    redirect("select.php");
    
} else {
    // -----------------------------------------
    // ログイン失敗時の処理
    // -----------------------------------------
    // ログインページにリダイレクト
    // ※セキュリティ上、失敗理由は詳しく表示しない
    // -----------------------------------------
    redirect("login.php");
}

