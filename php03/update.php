<?php
// ===========================================
// データ更新処理（update.php）
// ===========================================
// セッションチェックを追加
// ログイン済みユーザーのみ実行可能
// ===========================================


// -----------------------------------------
// 1. セッション開始（最初に記述必須！）
// -----------------------------------------
session_start();


// -----------------------------------------
// 2. 共通関数ファイルを読み込み
// -----------------------------------------
include("funcs.php");


// -----------------------------------------
// 3. ログイン状態をチェック
// -----------------------------------------
sschk();


// -----------------------------------------
// 4. POSTデータを取得
// -----------------------------------------
// フォームの name 属性の値をキーにして取得
// id は hidden フィールドから取得
// -----------------------------------------
$name   = $_POST["name"];
$email  = $_POST["email"];
$naiyou = $_POST["naiyou"];
$id     = $_POST["id"];  // 更新対象のID（hidden）


// -----------------------------------------
// 5. DB接続
// -----------------------------------------
$pdo = db_conn();


// -----------------------------------------
// 6. UPDATE文を作成・実行
// -----------------------------------------
// SET カラム名=値 で更新する値を指定
// WHERE id=:id で更新対象を限定（重要！）
// ※ WHERE を忘れると全データが更新される！
// -----------------------------------------
$sql = "UPDATE gs_an_table 
        SET name = :name, email = :email, naiyou = :naiyou 
        WHERE id = :id";

$stmt = $pdo->prepare($sql);

// プレースホルダーに値をバインド
$stmt->bindValue(':name',   $name,   PDO::PARAM_STR);
$stmt->bindValue(':email',  $email,  PDO::PARAM_STR);
$stmt->bindValue(':naiyou', $naiyou, PDO::PARAM_STR);
$stmt->bindValue(':id',     $id,     PDO::PARAM_INT);

// SQLを実行
$status = $stmt->execute();


// -----------------------------------------
// 7. 実行結果の判定とリダイレクト
// -----------------------------------------
// 成功時: select.php にリダイレクト
// 失敗時: エラーメッセージを表示
// -----------------------------------------
if ($status == false) {
    // SQLエラーの場合
    sql_error($stmt);
} else {
    // 成功時は一覧画面に戻る
    redirect("select.php");
}

