<?php
// ===========================================
// データ登録処理（insert.php）
// ===========================================
// セッションチェックを追加
// ログイン済みユーザーのみ実行可能
// ===========================================


// -----------------------------------------
// 1. セッション開始（最初に記述必須！）
// -----------------------------------------
session_start();


// -----------------------------------------
// 2. 共通関数ファイルを読み込み
// -----------------------------------------
include("funcs.php");


// -----------------------------------------
// 3. ログイン状態をチェック
// -----------------------------------------
sschk();


// -----------------------------------------
// 4. POSTデータを取得
// -----------------------------------------
// フォームの name 属性の値をキーにして取得
// 例: <input name="name"> → $_POST["name"]
// -----------------------------------------
$name   = $_POST["name"];
$email  = $_POST["email"];
$naiyou = $_POST["naiyou"];


// -----------------------------------------
// 5. DB接続
// -----------------------------------------
$pdo = db_conn();


// -----------------------------------------
// 6. INSERT文を作成・実行
// -----------------------------------------
// prepare() でSQL文をセット（プレースホルダー使用）
// bindValue() で安全に値をバインド（SQLインジェクション対策）
// execute() でSQLを実行
// -----------------------------------------
$sql = "INSERT INTO gs_an_table (name, email, naiyou, indate) 
        VALUES (:name, :email, :naiyou, sysdate())";

$stmt = $pdo->prepare($sql);

// プレースホルダーに値をバインド
// PDO::PARAM_STR = 文字列型
// PDO::PARAM_INT = 整数型
$stmt->bindValue(':name',   $name,   PDO::PARAM_STR);
$stmt->bindValue(':email',  $email,  PDO::PARAM_STR);
$stmt->bindValue(':naiyou', $naiyou, PDO::PARAM_STR);

// SQLを実行（成功: true, 失敗: false）
$status = $stmt->execute();


// -----------------------------------------
// 7. 実行結果の判定とリダイレクト
// -----------------------------------------
// 成功時: index.php にリダイレクト
// 失敗時: エラーメッセージを表示
// -----------------------------------------
if ($status == false) {
    // SQLエラーの場合
    sql_error($stmt);
} else {
    // 成功時は登録画面に戻る
    redirect("index.php");
}

